{% extends "base.html" %}

{% block title %}Warhammer 40K Army Cost Calculator — ThriftHammer{% endblock %}

{% block meta_description %}<meta name="description" content="Calculate the total cost of your Warhammer 40,000 army using real retailer prices. Pick your faction, add units, and instantly see how much your army costs across US stores.">{% endblock %}

{% block extra_head %}
<meta property="og:title" content="40K Army Cost Calculator — ThriftHammer">
<meta property="og:description" content="Build your 40K army list and see the real cost. Compare prices across US retailers for every unit in your roster.">
<meta property="og:type" content="website">
<link rel="canonical" href="https://www.thrifthammer.com/army-calculator/">
{% endblock %}

{% block content %}
<div class="page-content">

  {# ── Header ── #}
  <div style="margin-bottom:var(--sp-5);">
    <h1 class="section-title">40K Army Cost Calculator</h1>
    <div class="gold-rule"></div>
    <p style="color:var(--text-muted);font-size:0.9rem;max-width:600px;">
      Select your faction, build your roster unit by unit, and see the real cost across all tracked US retailers in real time.
    </p>
  </div>

  {# ── Faction filter bar ── #}
  {% if available_factions %}
  <div class="calc-faction-bar" role="navigation" aria-label="Select faction">
    <a href="{% url 'calculators:space_marines' %}"
       class="calc-faction-btn{% if not selected_faction %} active{% endif %}">
      All Factions
    </a>
    {% for faction in available_factions %}
    <a href="?faction={{ faction.slug }}"
       class="calc-faction-btn{% if selected_faction.slug == faction.slug %} active{% endif %}">
      {{ faction.name }}
    </a>
    {% endfor %}
  </div>
  {% endif %}

  <div class="calc-layout">

    {# ===== Unit picker ===== #}
    <div class="unit-picker">
      {% for cat_key, cat in ordered_categories %}
      <div class="unit-category" data-category="{{ cat_key }}">
        <div class="unit-category-header">{{ cat.label }}</div>
        {% for unit in cat.units %}
        <div class="unit-row" id="unit-row-{{ unit.pk }}" data-unit-id="{{ unit.pk }}"
             data-name="{{ unit.name|escapejs }}"
             data-points="{{ unit.points_cost|default:0 }}"
             data-typical-qty="{{ unit.typical_quantity }}"
             data-price="{% if unit.product %}{{ unit.product.get_cheapest_price.price|default:'' }}{% endif %}"
             data-msrp="{% if unit.product %}{{ unit.product.msrp|default:'' }}{% endif %}">
          <span class="unit-name">{{ unit.name }}</span>
          <span class="unit-pts">{{ unit.points_cost }}pts × {{ unit.typical_quantity }}</span>
          <span class="unit-price">
            {% if unit.product %}
              {% with best=unit.product.get_cheapest_price %}
                {% if best %}<span style="color:var(--accent-green-lt);">${{ best.price }}</span>{% else %}<span style="color:var(--text-muted);">—</span>{% endif %}
              {% endwith %}
            {% else %}
              <span style="color:var(--text-muted);" title="No product linked">—</span>
            {% endif %}
          </span>
          <div class="unit-qty" style="display:none;">
            <button type="button" class="decrease-qty" title="Decrease">−</button>
            <span class="qty-display">1</span>
            <button type="button" class="increase-qty" title="Increase">+</button>
            <button type="button" class="remove-unit" title="Remove">✕</button>
          </div>
          <button type="button" class="btn btn-primary btn-sm add-unit-btn" style="min-width:52px;">Add</button>
        </div>
        {% endfor %}
      </div>
      {% empty %}
      <div class="card" style="text-align:center;padding:var(--sp-8);">
        <p style="color:var(--text-muted);margin-bottom:var(--sp-3);">
          {% if selected_faction %}
            No units found for <strong>{{ selected_faction.name }}</strong> yet.
            Units are added as product SKUs are tagged in the admin.
          {% else %}
            No units found. Select a faction above or add units via the admin.
          {% endif %}
        </p>
        {% if not selected_faction %}
        <a href="{% url 'products:list' %}?category=warhammer-40000" class="btn btn-secondary">
          Browse 40K Products
        </a>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    {# ===== Sidebar ===== #}
    <aside class="calc-sidebar">

      {# Totals card #}
      <div class="totals-card">
        <h3>Army Totals</h3>
        <div class="total-row points">
          <span class="label">Points</span>
          <span class="value" id="total-points">0</span>
        </div>
        <hr class="totals-divider">
        <div class="total-row cost">
          <span class="label">Best Price</span>
          <span class="value" id="total-cost">$0.00</span>
        </div>
        <div class="total-row">
          <span class="label">GW MSRP</span>
          <span class="value" id="total-retail">$0.00</span>
        </div>
        <div class="total-row savings">
          <span class="label">You Save</span>
          <span class="value" id="total-savings">$0.00</span>
        </div>

        <div class="selected-units">
          <h4>Selected Units</h4>
          <div id="selected-units-list">
            <p class="no-units-msg">No units added yet.</p>
          </div>
        </div>
      </div>

      {# Save army (logged-in only) #}
      {% if user.is_authenticated %}
      <div class="totals-card">
        <h3>Save List</h3>
        <input type="text" id="army-name-input" class="army-name-input input"
               placeholder="Enter army name…" maxlength="200">
        <div class="save-actions">
          <label>
            <input type="checkbox" id="army-public-toggle"> Make shareable (anyone with link)
          </label>
          <button type="button" id="save-army-btn" class="btn btn-primary btn-full">Save Army List</button>
          <p id="save-status" style="font-size:0.8rem;color:var(--text-muted);display:none;margin-top:var(--sp-2);"></p>
        </div>
      </div>
      {% else %}
      <div class="totals-card" style="text-align:center;">
        <p style="color:var(--text-muted);font-size:0.875rem;margin-bottom:var(--sp-4);">
          <a href="{% url 'accounts:login' %}">Log in</a> to save and share your army lists.
        </p>
        <a href="{% url 'accounts:register' %}" class="btn btn-secondary btn-full">Create Free Account</a>
      </div>
      {% endif %}

      {# Prebuilt quick-starts #}
      {% if prebuilt_armies %}
      <div class="totals-card prebuilt-section">
        <h4>Quick Start</h4>
        {% for army in prebuilt_armies %}
        <button type="button" class="prebuilt-btn"
                data-units="{{ army.units_data|safe }}"
                title="{{ army.description }}">
          {{ army.name }}
        </button>
        {% endfor %}
      </div>
      {% endif %}

      {# User's saved armies #}
      {% if saved_armies %}
      <div class="totals-card saved-armies-section">
        <h4>My Saved Lists</h4>
        {% for army in saved_armies %}
        <a class="saved-army-link" href="{{ army.get_absolute_url }}">
          {{ army.name }} — <span style="color:var(--text-muted);">{{ army.points_total }}pts</span>
        </a>
        {% endfor %}
        <a href="{% url 'calculators:my_armies' %}" style="font-size:0.8rem;color:var(--accent-gold-lt);display:block;margin-top:var(--sp-3);">
          View all my lists →
        </a>
      </div>
      {% endif %}

    </aside>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
/* army-calculator.js — vanilla JS army list manager
   Security: all user-visible text goes through escHtml() */
(function () {
  "use strict";

  var selectedUnits = {};

  function qs(sel) { return document.querySelector(sel); }
  function qsa(sel) { return Array.from(document.querySelectorAll(sel)); }
  function fmt(num) { return "$" + parseFloat(num || 0).toFixed(2); }

  function escHtml(s) {
    return String(s)
      .replace(/&/g, '&amp;').replace(/</g, '&lt;')
      .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function updateDisplay() {
    var points = 0, cost = 0, retail = 0, lines = [];

    Object.values(selectedUnits).forEach(function (u) {
      var unitPts  = u.points * u.typicalQty * u.quantity;
      var unitCost = parseFloat(u.price  || 0) * u.quantity;
      var unitRetail = parseFloat(u.msrp || 0) * u.quantity;
      points += unitPts; cost += unitCost; retail += unitRetail;
      lines.push(
        '<p class="selected-unit-line">' +
        escHtml(u.name) + ' ×' + u.quantity +
        ' <span style="color:var(--accent-green-lt)">' + fmt(unitCost) + '</span>' +
        ' <span style="color:var(--text-muted)">(' + unitPts + 'pts)</span></p>'
      );
    });

    qs('#total-points').textContent  = points;
    qs('#total-cost').textContent    = fmt(cost);
    qs('#total-retail').textContent  = fmt(retail);
    qs('#total-savings').textContent = fmt(retail - cost);

    var listEl = qs('#selected-units-list');
    listEl.innerHTML = lines.length ? lines.join('') : '<p class="no-units-msg">No units added yet.</p>';
  }

  function addUnit(unitId) {
    var row = qs('#unit-row-' + unitId);
    if (!row) return;
    if (!selectedUnits[unitId]) {
      selectedUnits[unitId] = {
        id: unitId,
        name: row.dataset.name,
        quantity: 1,
        points: parseInt(row.dataset.points, 10) || 0,
        typicalQty: parseInt(row.dataset.typicalQty, 10) || 1,
        price: row.dataset.price || '0',
        msrp: row.dataset.msrp || '0',
      };
    } else {
      selectedUnits[unitId].quantity = Math.min(20, selectedUnits[unitId].quantity + 1);
    }
    syncRowUI(unitId); updateDisplay();
  }

  function removeUnit(unitId) {
    delete selectedUnits[unitId];
    syncRowUI(unitId); updateDisplay();
  }

  function syncRowUI(unitId) {
    var row = qs('#unit-row-' + unitId);
    if (!row) return;
    var addBtn     = row.querySelector('.add-unit-btn');
    var qtyBlock   = row.querySelector('.unit-qty');
    var qtyDisplay = row.querySelector('.qty-display');
    if (selectedUnits[unitId]) {
      addBtn.style.display = 'none';
      qtyBlock.style.display = 'flex';
      qtyDisplay.textContent = selectedUnits[unitId].quantity;
      row.classList.add('selected');
    } else {
      addBtn.style.display = '';
      qtyBlock.style.display = 'none';
      row.classList.remove('selected');
    }
  }

  function loadPrebuiltArmy(unitsJson) {
    var units;
    try { units = (typeof unitsJson === 'string') ? JSON.parse(unitsJson) : unitsJson; }
    catch (e) { return; }
    Object.keys(selectedUnits).forEach(function (id) { delete selectedUnits[id]; syncRowUI(id); });
    units.forEach(function (u) {
      var id = u.unit_type_id;
      var row = qs('#unit-row-' + id);
      if (!row) return;
      selectedUnits[id] = {
        id: id, name: row.dataset.name || u.name,
        quantity: u.quantity || 1,
        points: parseInt(row.dataset.points, 10) || 0,
        typicalQty: parseInt(row.dataset.typicalQty, 10) || 1,
        price: row.dataset.price || '0',
        msrp: row.dataset.msrp || '0',
      };
      syncRowUI(id);
    });
    updateDisplay();
  }

  function saveArmy() {
    var name = (qs('#army-name-input') || {}).value || '';
    var isPublic = (qs('#army-public-toggle') || {}).checked || false;
    var statusEl = qs('#save-status');

    if (!name.trim()) {
      if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'Please enter an army name.'; }
      return;
    }
    var unitList = Object.values(selectedUnits).map(function (u) { return { id: u.id, quantity: u.quantity }; });
    if (!unitList.length) {
      if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'Add some units first!'; }
      return;
    }
    if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'Saving…'; }

    fetch("{% url 'calculators:save_army' %}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
      body: JSON.stringify({ name: name, units: unitList, is_public: isPublic }),
    })
    .then(function (r) { return r.json(); })
    .then(function (data) {
      if (data.success) {
        statusEl.textContent = 'Saved! ';
        var link = document.createElement('a');
        link.href = data.url; link.textContent = 'View list →';
        statusEl.appendChild(link);
      } else {
        if (statusEl) statusEl.textContent = data.error || 'Save failed.';
      }
    })
    .catch(function () { if (statusEl) statusEl.textContent = 'Network error — please try again.'; });
  }

  function getCookie(name) {
    var value = '; ' + document.cookie;
    var parts = value.split('; ' + name + '=');
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  }

  /* Event delegation */
  document.addEventListener('click', function (e) {
    var row = e.target.closest('.unit-row');
    if (!row) return;
    var unitId = row.dataset.unitId;
    if (e.target.classList.contains('add-unit-btn')) {
      addUnit(unitId);
    } else if (e.target.classList.contains('increase-qty')) {
      if (selectedUnits[unitId]) {
        selectedUnits[unitId].quantity = Math.min(20, selectedUnits[unitId].quantity + 1);
        syncRowUI(unitId); updateDisplay();
      }
    } else if (e.target.classList.contains('decrease-qty')) {
      if (selectedUnits[unitId]) {
        selectedUnits[unitId].quantity -= 1;
        if (selectedUnits[unitId].quantity <= 0) removeUnit(unitId);
        else { syncRowUI(unitId); updateDisplay(); }
      }
    } else if (e.target.classList.contains('remove-unit')) {
      removeUnit(unitId);
    }
  });

  qsa('.prebuilt-btn').forEach(function (btn) {
    btn.addEventListener('click', function () { loadPrebuiltArmy(btn.dataset.units); });
  });

  var saveBtn = qs('#save-army-btn');
  if (saveBtn) saveBtn.addEventListener('click', saveArmy);

  updateDisplay();
})();
</script>
{% endblock %}
