{% extends "base.html" %}

{% block title %}My Watchlist{% endblock %}

{% block content %}
<div class="page-content">

  <div style="display:flex;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;gap:var(--sp-4);margin-bottom:var(--sp-2);">
    <div>
      <h1 class="section-title">
        My Watchlist
        {% if total %}<span style="color:var(--text-muted);font-size:0.9rem;font-weight:400;font-family:'Inter',sans-serif;">({{ total }})</span>{% endif %}
      </h1>
      <div class="gold-rule"></div>
    </div>
    <a href="{% url 'products:list' %}" class="btn btn-secondary">Browse Products</a>
  </div>

  {% if enriched %}
  <div style="display:flex;flex-direction:column;gap:var(--sp-3);">
    {% for row in enriched %}
    <div class="card{% if row.price_dropped %} price-drop-card{% endif %}"
         style="padding:var(--sp-4) var(--sp-5);">

      {# Price drop top banner #}
      {% if row.price_dropped %}
      <div style="background:rgb(45 122 79 / 0.15);border:1px solid rgb(45 122 79 / 0.4);border-radius:var(--rounded);padding:var(--sp-2) var(--sp-4);margin-bottom:var(--sp-4);display:flex;align-items:center;gap:var(--sp-2);">
        <span style="color:var(--accent-green-lt);font-family:'Oswald',sans-serif;font-size:0.78rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;">
          ‚¨á Price Below Target!
        </span>
      </div>
      {% endif %}

      <div style="display:grid;grid-template-columns:80px 1fr auto;gap:var(--sp-4);align-items:center;">

        {# Image #}
        {% if row.item.product.image_url %}
        <img src="{{ row.item.product.image_url }}" alt="{{ row.item.product.name }}"
             style="width:80px;height:80px;object-fit:contain;background:var(--bg-elevated);border-radius:var(--rounded);border:1px solid var(--border-subtle);">
        {% else %}
        <div style="width:80px;height:80px;background:var(--bg-elevated);border-radius:var(--rounded);border:1px solid var(--border-subtle);display:flex;align-items:center;justify-content:center;color:var(--border-mid);font-family:'Cinzel',serif;font-size:1.1rem;font-weight:900;" aria-hidden="true">TH</div>
        {% endif %}

        {# Info #}
        <div>
          <h3 style="font-size:1rem;font-weight:600;margin-bottom:var(--sp-1);">
            <a href="{% url 'products:detail' row.item.product.slug %}" style="color:var(--text-primary);">
              {{ row.item.product.name }}
            </a>
          </h3>
          <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:var(--sp-3);">
            {% if row.item.product.category %}{{ row.item.product.category.name }}{% endif %}
            {% if row.item.product.faction %} ¬∑ {{ row.item.product.faction.name }}{% endif %}
            ¬∑ Added {{ row.item.created_at|date:"d M Y" }}
          </p>
          <div style="display:flex;gap:var(--sp-4);flex-wrap:wrap;align-items:center;">
            {% if row.best %}
            <span style="font-size:1.1rem;font-weight:700;color:var(--accent-green-lt);">
              ${{ row.best.price }}
              <span style="font-size:0.75rem;font-weight:400;color:var(--text-muted);">at {{ row.best.retailer.name }}</span>
            </span>
            {% else %}
            <span style="color:var(--text-muted);font-size:0.9rem;">No price data</span>
            {% endif %}
            {% if row.item.target_price %}
            <span style="font-size:0.85rem;color:var(--text-muted);">
              Target: <strong style="color:var(--accent-gold-lt);">${{ row.item.target_price }}</strong>
            </span>
            {% endif %}
          </div>
        </div>

        {# Actions #}
        <div style="display:flex;flex-direction:column;gap:var(--sp-2);align-items:flex-end;">
          <a href="{% url 'products:detail' row.item.product.slug %}" class="btn btn-primary btn-sm">View</a>
          <form method="post" action="{% url 'products:toggle_watchlist' row.item.product.slug %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-secondary btn-sm">Remove</button>
          </form>
        </div>

      </div>
    </div>
    {% endfor %}
  </div>

  {% else %}
  <div style="text-align:center;padding:var(--sp-16) 0;color:var(--text-muted);">
    <div style="font-size:3rem;margin-bottom:var(--sp-4);" aria-hidden="true">üëÅ</div>
    <p style="font-size:1rem;margin-bottom:var(--sp-2);">Your watchlist is empty.</p>
    <p style="font-size:0.875rem;margin-bottom:var(--sp-6);">
      Browse products and click <strong style="color:var(--text-primary);">"Add to Watchlist"</strong> to track prices.
    </p>
    <a href="{% url 'products:list' %}" class="btn btn-primary">Browse Products</a>
  </div>
  {% endif %}

</div>
{% endblock %}
