{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ThriftHammer{% endblock %} ‚Äî Warhammer Price Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Oswald:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    {% block extra_head %}{% endblock %}
</head>
<body>

    <nav class="navbar" role="navigation" aria-label="Main navigation">
        <div class="container navbar-inner">

            {# Brand / Logo #}
            <a href="{% url 'home' %}" class="navbar-brand" aria-label="ThriftHammer home">
                <img src="{% static 'images/logo.svg' %}" alt="ThriftHammer" class="brand-logo" width="200" height="43">
            </a>

            {# Center search bar ‚Äî hidden on mobile (shown in hero) #}
            <div class="navbar-search" role="search">
                <span class="navbar-search-icon" aria-hidden="true">üîç</span>
                <input
                    type="text"
                    id="navbar-search-input"
                    placeholder="Search‚Ä¶"
                    autocomplete="off"
                    aria-label="Search products"
                >
                <div id="navbar-search-results" class="hero-search-results" role="listbox" aria-label="Search suggestions"></div>
            </div>

            {# Right-side links #}
            <div class="navbar-links">
                <a href="{% url 'products:list' %}">Browse</a>
                <a href="{% url 'about' %}">About</a>
                <a href="{% url 'calculators:space_marines' %}" class="nav-cta">‚öî Army Calculator</a>
                {% if user.is_authenticated %}
                    <a href="{% url 'collections:my_collection' %}">Collection</a>
                    <a href="{% url 'calculators:my_armies' %}">My Armies</a>
                    <a href="{% url 'accounts:watchlist' %}" class="watchlist-badge">
                        üëÅ Watchlist{% with count=request.user.watchlist_items.count %}{% if count %} <strong>({{ count }})</strong>{% endif %}{% endwith %}
                    </a>
                    <a href="{% url 'accounts:profile' %}">{{ user.username }}</a>
                    <a href="{% url 'accounts:logout' %}">Logout</a>
                {% else %}
                    <a href="{% url 'accounts:login' %}">Login</a>
                    <a href="{% url 'accounts:register' %}">Register</a>
                {% endif %}
            </div>

        </div>
    </nav>

    {# Flash messages #}
    {% if messages %}
    <div class="container" role="alert" aria-live="polite">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <main id="main-content">
        {% block content %}{% endblock %}
    </main>

    <footer class="footer" role="contentinfo">
        <div class="container">
            <div class="footer-grid">

                {# Col 1 ‚Äî Brand + about #}
                <div class="footer-brand">
                    <img src="{% static 'images/logo.svg' %}" alt="ThriftHammer" class="footer-logo" width="180" height="39">
                    <p>
                        Track prices on Warhammer kits across US retailers.
                        Find the best deal and never overpay for plastic soldiers again.
                    </p>
                </div>

                {# Col 2 ‚Äî Browse links #}
                <div class="footer-col">
                    <h4>Browse</h4>
                    <a href="{% url 'products:list' %}">All Products</a>
                    <a href="{% url 'products:list' %}?sort=price_asc">Cheapest First</a>
                    <a href="{% url 'calculators:space_marines' %}">Army Calculator</a>
                    {% if user.is_authenticated %}
                    <a href="{% url 'accounts:watchlist' %}">My Watchlist</a>
                    <a href="{% url 'collections:my_collection' %}">My Collection</a>
                    {% endif %}
                </div>

                {# Col 3 ‚Äî Account + legal #}
                <div class="footer-col">
                    <h4>Company</h4>
                    <a href="{% url 'about' %}">About ThriftHammer</a>
                    <a href="mailto:thrifthammer.com@gmail.com">Contact Us</a>
                    <h4 style="margin-top:var(--sp-4);">Account</h4>
                    <a href="{% url 'accounts:login' %}">Sign In</a>
                    <a href="{% url 'accounts:register' %}">Create Account</a>
                    <h4 style="margin-top:var(--sp-4);">Legal</h4>
                    <a href="{% url 'privacy_policy' %}">Privacy Policy</a>
                    <a href="{% url 'privacy_policy' %}#affiliate">Affiliate Disclosure</a>
                </div>

                {# Col 4 ‚Äî Affiliate disclosures #}
                <div class="footer-col footer-disclosures">
                    <h4>Affiliate Disclosures</h4>
                    <p class="disclosure-text">
                        <strong>Amazon:</strong> As an Amazon Associate ThriftHammer earns
                        from qualifying purchases. <em>(#ad)</em>
                    </p>
                    <p class="disclosure-text">
                        <strong>eBay:</strong> ThriftHammer is a member of the eBay Partner
                        Network. We may earn commission on qualifying purchases.
                        <em>(#CommissionsEarned)</em>
                    </p>
                    <p class="disclosure-text">
                        <strong>Miniature Market:</strong> ThriftHammer participates in the
                        Miniature Market affiliate program via Impact.
                    </p>
                    <p class="disclosure-text">
                        Commissions do not affect price rankings. We always show
                        the cheapest price first.
                    </p>
                </div>

            </div>

            {# Full-width affiliate disclosure bar ‚Äî FTC / EPN require it to be conspicuous #}
            <div class="footer-affiliate-bar">
                <span>
                    <strong>#ad</strong> ‚Äî Outbound retailer links on this site may be
                    affiliate links. ThriftHammer participates in the Amazon Associates,
                    eBay Partner Network, and Miniature Market affiliate programs and
                    may earn commissions on qualifying purchases at no cost to you.
                    <a href="{% url 'privacy_policy' %}#affiliate">Full disclosure ‚Üí</a>
                </span>
            </div>

            <div class="footer-bottom">
                <span>&copy; {% now "Y" %} ThriftHammer. Not affiliated with or endorsed by Games Workshop Ltd.</span>
                <span>Prices from US retailers. Always verify before purchasing.</span>
            </div>
        </div>
    </footer>

    {% block extra_js %}{% endblock %}

    {# Navbar search autocomplete ‚Äî shared across all pages #}
    <script>
    (function () {
        "use strict";
        var input    = document.getElementById("navbar-search-input");
        var dropdown = document.getElementById("navbar-search-results");
        if (!input || !dropdown) return;

        var timer;

        input.addEventListener("input", function () {
            clearTimeout(timer);
            var q = input.value.trim();
            if (q.length < 2) { dropdown.style.display = "none"; return; }
            timer = setTimeout(function () {
                fetch("{% url 'products:search_autocomplete' %}?q=" + encodeURIComponent(q))
                    .then(function (r) { return r.json(); })
                    .then(function (data) {
                        dropdown.innerHTML = "";
                        if (!data.results || !data.results.length) {
                            dropdown.style.display = "none";
                            return;
                        }
                        data.results.forEach(function (r) {
                            var a = document.createElement("a");
                            a.href = "/products/" + r.slug + "/";
                            var name = document.createElement("span");
                            name.textContent = r.name;
                            a.appendChild(name);
                            if (r.msrp) {
                                var price = document.createElement("span");
                                price.className = "ac-price";
                                price.textContent = "$" + parseFloat(r.msrp).toFixed(2);
                                a.appendChild(price);
                            }
                            dropdown.appendChild(a);
                        });
                        dropdown.style.display = "block";
                    })
                    .catch(function () { dropdown.style.display = "none"; });
            }, 250);
        });

        document.addEventListener("click", function (e) {
            if (!e.target.closest(".navbar-search")) {
                dropdown.style.display = "none";
            }
        });

        input.addEventListener("keydown", function (e) {
            if (e.key === "Escape") { dropdown.style.display = "none"; }
            if (e.key === "ArrowDown") {
                var first = dropdown.querySelector("a");
                if (first) { e.preventDefault(); first.focus(); }
            }
            if (e.key === "Enter") {
                e.preventDefault();
                window.location.href = "{% url 'products:list' %}?q=" + encodeURIComponent(input.value.trim());
            }
        });
    })();
    </script>

</body>
</html>
