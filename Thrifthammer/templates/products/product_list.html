{% extends "base.html" %}

{% block title %}Browse Warhammer 40K Products — Compare Prices{% endblock %}

{% block meta_description %}<meta name="description" content="Browse all Warhammer 40,000 kits and compare prices across US retailers including Games Workshop, Miniature Market, Noble Knight, Amazon and more.">{% endblock %}

{% block extra_head %}
<meta property="og:title" content="Browse Warhammer 40K Products — ThriftHammer">
<meta property="og:description" content="Find the cheapest price on every Warhammer 40,000 kit. Filter by faction, compare retailers, save money.">
<meta property="og:type" content="website">
<link rel="canonical" href="https://www.thrifthammer.com/products/">
{% endblock %}

{% block content %}
<div class="page-content">

  {# ── Page header ── #}
  <div style="margin-bottom:var(--sp-5);">
    <h1 class="section-title">Browse Products</h1>
    <div class="gold-rule"></div>
  </div>

  {# ── Mobile hamburger trigger (hidden on desktop) ── #}
  <button class="sidebar-hamburger" id="sidebar-toggle-btn" aria-expanded="false" aria-controls="browse-sidebar">
    <div class="hamburger-lines" aria-hidden="true">
      <span></span><span></span><span></span>
    </div>
    Filters &amp; Categories
  </button>

  {# ── Main browse layout ── #}
  <div class="browse-layout">

    {# ─── LEFT SIDEBAR ─────────────────────────────────────────── #}
    <aside class="browse-sidebar" id="browse-sidebar" role="complementary" aria-label="Filters">

      {# Search #}
      <div class="sidebar-section">
        <button class="sidebar-toggle open" data-target="search-body" aria-expanded="true">
          Search
          <span class="toggle-icon" aria-hidden="true">▾</span>
        </button>
        <div class="sidebar-body" id="search-body">
          <form method="get" id="search-form" role="search">
            {# Carry forward active category/faction/sort when searching #}
            {% if selected_category %}<input type="hidden" name="category" value="{{ selected_category }}">{% endif %}
            {% if selected_faction %}<input type="hidden" name="faction" value="{{ selected_faction }}">{% endif %}
            {% if sort %}<input type="hidden" name="sort" value="{{ sort }}">{% endif %}
            <div style="position:relative;">
              <input
                type="text" name="q" id="search-input"
                value="{{ query }}"
                placeholder="Search…"
                autocomplete="off"
                aria-label="Search products"
                style="width:100%;padding:0.5rem 2.2rem 0.5rem 0.75rem;border:1px solid var(--border-subtle);border-radius:var(--rounded);background:var(--bg-input);color:var(--text-primary);font-size:0.85rem;font-family:inherit;"
              >
              <button type="submit" aria-label="Submit search"
                style="position:absolute;right:0.5rem;top:50%;transform:translateY(-50%);background:url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 fill=%22none%22 stroke=%22%23c8921a%22 stroke-width=%222%22 viewBox=%220 0 24 24%22%3E%3Ccircle cx=%2211%22 cy=%2211%22 r=%227%22/%3E%3Cline x1=%2216.5%22 y1=%2216.5%22 x2=%2222%22 y2=%2222%22/%3E%3C/svg%3E') no-repeat center/contain;border:none;cursor:pointer;padding:0;width:14px;height:14px;">
              </button>
            </div>
            <div id="autocomplete-results" class="hero-search-results" role="listbox" aria-label="Suggestions" style="top:calc(100% + 2px);"></div>
            {% if query %}
            <a href="{% url 'products:list' %}{% if selected_category %}?category={{ selected_category }}{% endif %}"
               style="font-size:0.75rem;color:var(--text-muted);display:block;margin-top:var(--sp-2);">
              ✕ Clear search
            </a>
            {% endif %}
          </form>
        </div>
      </div>

      {# Sort #}
      <div class="sidebar-section">
        <button class="sidebar-toggle open" data-target="sort-body" aria-expanded="true">
          Sort By
          <span class="toggle-icon" aria-hidden="true">▾</span>
        </button>
        <div class="sidebar-body" id="sort-body">
          <form method="get" id="sort-form">
            {% if query %}<input type="hidden" name="q" value="{{ query }}">{% endif %}
            {% if selected_category %}<input type="hidden" name="category" value="{{ selected_category }}">{% endif %}
            {% if selected_faction %}<input type="hidden" name="faction" value="{{ selected_faction }}">{% endif %}
            <select name="sort" class="sidebar-select" onchange="document.getElementById('sort-form').submit();"
                    aria-label="Sort products">
              {% for value, label in sort_options %}
              <option value="{{ value }}"{% if sort == value %} selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </form>
        </div>
      </div>

      {# Categories #}
      {% if categories %}
      <div class="sidebar-section">
        <button class="sidebar-toggle open" data-target="cats-body" aria-expanded="true">
          Categories
          <span class="toggle-icon" aria-hidden="true">▾</span>
        </button>
        <div class="sidebar-body" id="cats-body">
          <a href="{% url 'products:list' %}{% if query %}?q={{ query }}{% endif %}{% if sort and sort != 'name' %}{% if query %}&{% else %}?{% endif %}sort={{ sort }}{% endif %}"
             class="sidebar-link{% if not selected_category %} active{% endif %}">
            All Categories
          </a>
          {% for cat in categories %}
          <a href="?{% if query %}q={{ query }}&{% endif %}category={{ cat.slug }}{% if sort and sort != 'name' %}&sort={{ sort }}{% endif %}"
             class="sidebar-link{% if selected_category == cat.slug %} active{% endif %}">
            {{ cat.name }}
          </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {# Factions — only shown when a category is selected (hierarchical filter) #}
      {% if selected_category %}
      <div class="sidebar-section">
        <button class="sidebar-toggle open" data-target="facs-body" aria-expanded="true">
          Factions
          <span class="toggle-icon" aria-hidden="true">▾</span>
        </button>
        <div class="sidebar-body" id="facs-body">
          {% if factions %}
          <a href="?{% if query %}q={{ query }}&{% endif %}category={{ selected_category }}{% if sort and sort != 'name' %}&sort={{ sort }}{% endif %}"
             class="sidebar-link{% if not selected_faction %} active{% endif %}">
            All Factions
          </a>
          {% for f in factions %}
          <a href="?{% if query %}q={{ query }}&{% endif %}category={{ selected_category }}&faction={{ f.slug }}{% if sort and sort != 'name' %}&sort={{ sort }}{% endif %}"
             class="sidebar-link{% if selected_faction == f.slug %} active{% endif %}">
            {{ f.name }}
          </a>
          {% endfor %}
          {% else %}
          <p style="font-size:0.78rem;color:var(--text-muted);padding:var(--sp-2) 0;">No factions in this category.</p>
          {% endif %}
        </div>
      </div>
      {% else %}
      <div class="sidebar-section">
        <div style="padding:var(--sp-2) 0;">
          <p style="font-size:0.78rem;color:var(--text-muted);">Select a category to filter by faction.</p>
        </div>
      </div>
      {% endif %}

      {# Clear all filters #}
      {% if query or selected_category or selected_faction %}
      <a href="{% url 'products:list' %}" class="btn btn-secondary btn-full" style="margin-top:var(--sp-2);">
        ✕ Clear All Filters
      </a>
      {% endif %}

    </aside>

    {# ─── MAIN CONTENT ─────────────────────────────────────────── #}
    <main>

      {# Result count + active filter summary #}
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:var(--sp-2);margin-bottom:var(--sp-4);">
        <p style="font-size:0.85rem;color:var(--text-muted);">
          <strong style="color:var(--text-primary);">{{ total_count }}</strong>
          product{{ total_count|pluralize }}
          {% if query %} matching "<em style="color:var(--accent-gold-lt);">{{ query }}</em>"{% endif %}
          {% if selected_category %} in <em style="color:var(--accent-gold-lt);">{{ selected_category }}</em>{% endif %}
          {% if selected_faction %} · <em style="color:var(--accent-gold-lt);">{{ selected_faction }}</em>{% endif %}
        </p>
      </div>

      {# Product grid #}
      <div class="card-grid">
        {% for product in products %}
        <a href="{% url 'products:detail' product.slug %}" class="product-card">

          {% if product.image_url %}
          <img
            src="{{ product.image_url }}"
            alt="{{ product.name }}"
            class="product-card-img"
            loading="lazy"
          >
          {% else %}
          <div class="product-card-img-placeholder" aria-hidden="true"></div>
          {% endif %}

          <div class="product-card-body">
            <div class="product-card-name">{{ product.name }}</div>

            <div class="product-card-badges">
              {% if product.category %}<span class="badge badge-default">{{ product.category.name }}</span>{% endif %}
              {% if product.faction %}<span class="badge badge-purple">{{ product.faction.name }}</span>{% endif %}
            </div>

            <div class="product-card-pricing">
              {% if product.min_price %}
              <div class="product-card-price-label">Best Price</div>
              <div class="product-card-price">${{ product.min_price|floatformat:"2" }}</div>
              {% if product.msrp and product.min_price < product.msrp %}
              <div style="display:flex;align-items:center;gap:var(--sp-1);flex-wrap:wrap;margin-top:var(--sp-1);">
                <span class="product-card-msrp">RRP ${{ product.msrp }}</span>
                <span class="badge badge-green">Save</span>
              </div>
              {% endif %}
              {% elif product.msrp %}
              <div class="product-card-price-label">MSRP</div>
              <div style="font-size:1rem;font-weight:600;color:var(--text-secondary);">${{ product.msrp }}</div>
              {% else %}
              <div class="product-card-price-label" style="padding-top:var(--sp-2);color:var(--text-muted);">No price yet</div>
              {% endif %}
            </div>
          </div>

        </a>
        {% empty %}
        <div style="grid-column:1/-1;text-align:center;padding:var(--sp-16) 0;">
          <div style="font-size:2.5rem;margin-bottom:var(--sp-4);font-weight:900;color:var(--accent-gold);" aria-hidden="true">—</div>
          <p style="font-size:1rem;margin-bottom:var(--sp-4);color:var(--text-muted);">
            No products found{% if query %} for "{{ query }}"{% endif %}.
          </p>
          <a href="{% url 'products:list' %}" class="btn btn-secondary">Clear All Filters</a>
        </div>
        {% endfor %}
      </div>

      {# Pagination #}
      {% if paginator.num_pages > 1 %}
      <nav class="pagination" aria-label="Page navigation">
        {% if page_obj.has_previous %}
        <a href="?q={{ query }}&category={{ selected_category }}&faction={{ selected_faction }}&sort={{ sort }}&page={{ page_obj.previous_page_number }}" aria-label="Previous page">&laquo; Prev</a>
        {% else %}
        <span class="disabled" aria-disabled="true">&laquo; Prev</span>
        {% endif %}

        {% for num in paginator.page_range %}
          {% if num == page_obj.number %}
          <span class="current" aria-current="page">{{ num }}</span>
          {% elif num >= page_obj.number|add:"-3" and num <= page_obj.number|add:"3" %}
          <a href="?q={{ query }}&category={{ selected_category }}&faction={{ selected_faction }}&sort={{ sort }}&page={{ num }}">{{ num }}</a>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <a href="?q={{ query }}&category={{ selected_category }}&faction={{ selected_faction }}&sort={{ sort }}&page={{ page_obj.next_page_number }}" aria-label="Next page">Next &raquo;</a>
        {% else %}
        <span class="disabled" aria-disabled="true">Next &raquo;</span>
        {% endif %}
      </nav>
      {% endif %}

    </main>
  </div>{# end browse-layout #}

</div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
  "use strict";

  /* ── Sidebar collapsible sections ── */
  document.querySelectorAll('.sidebar-toggle').forEach(function (btn) {
    btn.addEventListener('click', function () {
      var targetId = btn.dataset.target;
      var body = document.getElementById(targetId);
      if (!body) return;
      var collapsed = body.classList.toggle('collapsed');
      btn.classList.toggle('open', !collapsed);
      btn.setAttribute('aria-expanded', !collapsed);
    });
  });

  /* ── Mobile sidebar hamburger ── */
  var hamburger = document.getElementById('sidebar-toggle-btn');
  var sidebar   = document.getElementById('browse-sidebar');
  if (hamburger && sidebar) {
    hamburger.addEventListener('click', function () {
      var open = sidebar.classList.toggle('mobile-open');
      hamburger.setAttribute('aria-expanded', open);
    });
  }

  /* ── Search autocomplete ── */
  var input    = document.getElementById("search-input");
  var dropdown = document.getElementById("autocomplete-results");
  if (!input || !dropdown) return;

  var timer;
  input.addEventListener("input", function () {
    clearTimeout(timer);
    var q = input.value.trim();
    if (q.length < 2) { dropdown.style.display = "none"; return; }
    timer = setTimeout(function () {
      fetch("{% url 'products:search_autocomplete' %}?q=" + encodeURIComponent(q))
        .then(function (r) { return r.json(); })
        .then(function (data) {
          dropdown.innerHTML = "";
          if (!data.results || !data.results.length) { dropdown.style.display = "none"; return; }
          data.results.forEach(function (r) {
            var a = document.createElement("a");
            a.href = "/products/" + r.slug + "/";
            var name = document.createElement("span");
            name.textContent = r.name;
            a.appendChild(name);
            if (r.msrp) {
              var price = document.createElement("span");
              price.className = "ac-price";
              price.textContent = "$" + parseFloat(r.msrp).toFixed(2);
              a.appendChild(price);
            }
            dropdown.appendChild(a);
          });
          dropdown.style.display = "block";
        })
        .catch(function () { dropdown.style.display = "none"; });
    }, 200);
  });

  document.addEventListener("click", function (e) {
    if (!e.target.closest("#search-form")) dropdown.style.display = "none";
  });

  input.addEventListener("keydown", function (e) {
    if (e.key === "Escape") dropdown.style.display = "none";
    if (e.key === "ArrowDown") {
      var first = dropdown.querySelector("a");
      if (first) { e.preventDefault(); first.focus(); }
    }
  });
})();
</script>
{% endblock %}
